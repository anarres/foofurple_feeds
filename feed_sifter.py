#!/usr/bin/env python
# coding: utf-8

# Import system modules
import sys
import shelve
import json
import webbrowser
import time
from feed_utils import _slugify

# Import local modules
import cache
from settings import *


class SetOfFeeds(object):
    """ A 'stream' or set of feeds grouped together """

    def __init__(self, title, feeds_list):
        self.title = title
        self.feeds_list = feeds_list

    def __str__(self):
        return "SetOfFeeds object with title: %s" % self.title

    def get_urls(self):
        urls = []
        for f in self.feeds_list:
            urls.append(f['url'])
        return urls

    def get_filename(self):
        return "%s%s.html" % (OUTPUT_DIR, _slugify(self.title))

    

"""
CLASSES FOR PUTTING FEED DATA INTO THE FORMAT I WANT TO DISPLAY
"""
class EntryInfo(object):
    def __init__(self, feed_obj, link, title, author, description, content, date, images, audio, video):
        self.feed_obj = feed_obj
        self.link = link
        self.title = title
        self.author = author
        self.description = description
        self.content = content
        self.date = date
        self.nice_date = time.strftime("%a, %d %b %Y", date)
        self.images = images               # A list of urls
        self.audio = audio                 # A list of urls
        self.video = video                 # A list of urls

    def __str__(self):
        return "EntryInfo object, title: %s." % self.title

    def get_dict(self):
        my_dict = {'entry_link':self.link, 'entry_title':self.title, 'entry_author':self.author, 'entry_description':self.description, 'entry_content':self.content, 'entry_date':self.nice_date, 'feed_link':self.feed_obj.link, 'feed_title':self.feed_obj.title, 'feed_logo':self.feed_obj.logo, 'images':self.images, 'audio':self.audio, 'video':self.video}

        if self.content == 0:
            my_dict['entry_content'] = "<p>%s</p>" % self.description
        return my_dict



class FeedInfo(object):
    def __init__(self, link, title, logo):
        self.link = link
        self.title = title
        self.logo = logo     
    def __str__(self):
        return "FeedInfo object: title: %s, link: %s, logo: %s." % (self.title, self.link, self.logo)


"""
FUNCTIONS FOR CONVERTING PARSED FEED INTO THE INFO I WANT TO DISPLAY
"""
def get_feed_title(feed):
    """ Takes a feedparser feed object """
    try:
        return feed.title
    except:
        return "FEED TITLE UNKNOWN"

def get_feed_link(feed):
    """ Takes a feedparser feed object """
    try:
        return feed.link
    except:
        return "FEED LINK UNKNOWN"

def get_feed_logo(feed):
    """ Takes a feedparser feed object """
    try:
        return feed.logo
    except:
        try:
            return feed.image.href
        except:
            try:
                return feed.image
            except:
                return "FEED LOGO UNKNOWN"

def get_entry_link(e):
    """ Takes a feedparser entry object """
    try:
        return e.link
    except:
        return "ENTRY LINK UNKNOWN"

def get_entry_title(e):
    """ Takes a feedparser entry object """
    try:
        return e.title
    except:
        return "ENTRY TITLE UNKNOWN"

def get_entry_author(e):
    try:
        return e.author
    except:
        return "?"

def get_entry_description(e):
    return e.description
    """
    try:
        return e.description
    except:
        return "UNKNOWN"
    """

def get_entry_content(e):
    try:
        return e.content.value
    except:
        try:
            return e.content
        except:
            return 0

def get_entry_date(e):
    try:
        return e.updated_parsed
    except:
        try:
            return e.pubDate_parsed
        except:
            try:
                return e.published_parsed
            except:
                return "UNKNOWN"

def get_images(e):
    """ Returns a list of image urls """
    images = []
    for enclo in e.enclosures:
        if enclo.type[:5] == 'image':
            images.append(enclo.url)
    return images

def get_audio(e):
    """ Returns a list of urls """
    urls = []
    for enclo in e.enclosures:
        if enclo.type[:5] == 'audio':
            urls.append(enclo.url)
    return urls

def get_video(e):
    """ Returns a list of urls """
    urls = []
    for enclo in e.enclosures:
        if enclo.type[:5] == 'video':
            urls.append(enclo.url)
    return urls


def get_info( parsed_datums ):
    entry_info_objs = []
    for d in parsed_datums:
        f = d.feed
        feed_info_obj = FeedInfo( get_feed_link(f), get_feed_title(f), get_feed_logo(f) )

        for e in d.entries:
            e_info_obj = EntryInfo( feed_info_obj, get_entry_link(e), get_entry_title(e), get_entry_author(e), get_entry_description(e), get_entry_content(e), get_entry_date(e), get_images(e), get_audio(e), get_video(e) )
            entry_info_objs.append(e_info_obj)
    return sorted(entry_info_objs, key=lambda e: e.date, reverse=True)



def get_parsed_data(urls=[]):

    webbrowser.open('file:///home/katie/prog/foofurple_feeds/wait.html')
    parsed_datums = []

    print 'Saving feed data to ./.feedcache'
    storage = shelve.open('.feedcache')
    try:
        fc = cache.Cache(storage)
        for url in urls:
            parsed_data = fc.fetch(url)
            """
            for entry in parsed_data.entries:
                parsed_datums.append(entry)
            """
            parsed_datums.append(parsed_data)
    finally:
        storage.close()
    return parsed_datums
